<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tool Ghép Ảnh Acc Liên Quân (Full iPhone Support)</title>
<style>
  body{font-family:Inter,system-ui,sans-serif;background:#f5f7fb;margin:0;padding:10px}
  h2{text-align:center}
  .wrap{max-width:1100px;margin:auto}
  .card{background:#fff;border-radius:10px;padding:10px;box-shadow:0 4px 12px rgba(0,0,0,0.1);margin-bottom:10px}
  textarea{width:100%;height:100px;border-radius:6px;padding:8px;border:1px solid #ccc;font-family:monospace}
  input[type="file"],input[type="text"]{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;margin-top:4px}
  button{background:#007bff;color:#fff;border:none;padding:10px 14px;border-radius:6px;cursor:pointer}
  button:active{opacity:0.8}
  #log{background:#0f172a;color:#bcd;font-size:12px;padding:8px;border-radius:6px;height:140px;overflow:auto;white-space:pre-line}
  canvas{width:100%;max-width:807px;border:1px solid #ccc;border-radius:8px;background:#fff}
</style>
</head>
<body>
<div class="wrap">
  <h2>Tool Ghép Ảnh Acc Liên Quân (Full + iPhone Upload)</h2>

  <div class="card">
    <label>🧾 Dán thông tin acc:</label>
    <textarea id="accText" placeholder="Dán chuỗi info acc vào đây..."></textarea>

    <label>🖼️ Ảnh Acc:</label>
    <input type="file" id="accImageInput" accept="image/*">

    <label>📜 Ảnh Lịch sử đấu:</label>
    <input type="file" id="lichsuImageInput" accept="image/*">

    <label>🔢 Mã Số (MS):</label>
    <input type="text" id="maSoInput" placeholder="vd: 001">

    <div style="margin-top:10px;display:flex;gap:10px">
      <button id="btnLoad">Ghép Ảnh</button>
      <button id="btnDownload">Tải Ảnh</button>
    </div>
  </div>

  <div class="card">
    <div><b>📋 Log:</b></div>
    <div id="log">(chưa có log)</div>
  </div>

  <div class="card">
    <div><b>📷 Kết quả:</b></div>
    <canvas id="canvas" width="807" height="1280"></canvas>
  </div>
</div>

<script>
(async()=>{
const TOADO_URL = "https://raw.githubusercontent.com/HoshinoKotaSouma/shopaccbeorin/main/ToadoXyz.json";
const FILEID_URL = "https://raw.githubusercontent.com/HoshinoKotaSouma/ctvhogo/main/FileIdtuong.json";

const $=id=>document.getElementById(id);
const logEl=$('log');
function log(...a){logEl.textContent+=a.join(' ')+"\\n";logEl.scrollTop=99999;}

async function fetchJSON(u){const r=await fetch(u);if(!r.ok)throw new Error("Fetch lỗi "+u);return await r.json();}
function loadImage(url){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin="anonymous";i.onload=()=>res(i);i.onerror=()=>rej(new Error("Lỗi ảnh "+url));i.src=url;});}
function fileToImage(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=r.result;};r.onerror=rej;r.readAsDataURL(file);});}
function parseAcc(txt){const t=txt.match(/TƯỚNG\\s*:\\s*(\\d+)/i),s=txt.match(/SKIN\\s*:\\s*(\\d+)/i);return{tuong:t?+t[1]:0,skin:s?+s[1]:0};}

const canvas=$('canvas');const ctx=canvas.getContext('2d');
let toado,fileMap={};
try{
  log("🔹 Đang tải ToadoXyz...");
  toado=await fetchJSON(TOADO_URL);
  log("✅ Tải thành công ToadoXyz");
  log("🔹 Đang tải FileIdtuong...");
  const f=await fetchJSON(FILEID_URL);
  for(const k in f){fileMap[k]=f[k];}
  log("✅ Tải thành công FileIdtuong");
}catch(e){log("❌ Lỗi tải dữ liệu:",e.message);return;}

$('btnLoad').onclick=async()=>{
 try{
  log("🚀 Bắt đầu ghép...");
  const info=$('accText').value.trim();
  if(!info)return alert("Nhập thông tin acc!");
  const parsed=parseAcc(info);
  log("📊 Parsed:",JSON.stringify(parsed));

  const maSo=$('maSoInput').value.trim();
  const accFile=$('accImageInput').files[0];
  const lichsuFile=$('lichsuImageInput').files[0];
  if(!accFile||!lichsuFile)return alert("Chọn ảnh acc và lịch sử đấu!");

  const baseImg=await loadImage(toado.image.url);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(baseImg,0,0,canvas.width,canvas.height);
  log("🖼️ Đã vẽ ảnh nền");

  const accImg=await fileToImage(accFile);
  const lichsuImg=await fileToImage(lichsuFile);

  // vùng acc
  if(toado.extra&&toado.extra.accCrop){
    const c=toado.extra.accCrop;
    ctx.drawImage(accImg,c.x,c.y,c.w,c.h);
    log("✅ Dán ảnh acc");
  }
  // vùng lịch sử
  if(toado.extra&&toado.extra.lichsuCrop){
    const c=toado.extra.lichsuCrop;
    ctx.drawImage(lichsuImg,c.x,c.y,c.w,c.h);
    log("✅ Dán ảnh lịch sử đấu");
  }

  // ghi số tướng, skin
  const scx=canvas.width/toado.image.originalWidth;
  const scy=canvas.height/toado.image.originalHeight;
  ctx.font="bold 36px Arial";
  ctx.strokeStyle="#fff";
  ctx.lineWidth=3;
  ctx.fillStyle="#ff3b3b";
  if(toado.tuong)ctx.fillText(parsed.tuong,toado.tuong.original.x*scx,toado.tuong.original.y*scy);
  ctx.fillStyle="#1f8ef1";
  if(toado.skin)ctx.fillText(parsed.skin,toado.skin.original.x*scx,toado.skin.original.y*scy);

  // ghi mã số
  if(toado.ms){
    ctx.font=`bold ${toado.ms.fontSize||40}px Arial`;
    ctx.fillStyle="#fff";
    ctx.strokeStyle="#000";
    ctx.lineWidth=4;
    ctx.strokeText("MS : "+maSo,toado.ms.x,toado.ms.y);
    ctx.fillText("MS : "+maSo,toado.ms.x,toado.ms.y);
    log("🆔 Vẽ mã số:",maSo);
  }

  log("🎯 Hoàn thành!");

 }catch(e){
   log("❌ Lỗi:",e.message);
   alert("Lỗi: "+e.message);
 }
};

$('btnDownload').onclick=()=>{
  const a=document.createElement('a');
  a.download="acc_output.png";
  a.href=canvas.toDataURL('image/png');
  a.click();
};
})();
</script>
</body>
</html>
