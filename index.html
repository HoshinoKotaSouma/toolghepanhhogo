<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tool Gh√©p Skin (Auto + ·∫¢nh Acc + L·ªãch S·ª≠ + M√£ S·ªë)</title>
<style>
:root{--accent:#1f8ef1;--bg:#f5f7fb;--card:#fff}
body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:var(--bg);color:#111}
.wrap{max-width:1100px;margin:20px auto;padding:18px}
header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
h1{font-size:18px;margin:0}
.panel{display:grid;grid-template-columns:1fr 420px;gap:14px}
.card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 20px rgba(16,24,40,0.04)}
textarea{width:100%;height:120px;border-radius:8px;padding:10px;border:1px solid #e6e9ef;resize:vertical;font-family:monospace;}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
button.secondary{background:#4caf50}
.small{font-size:13px;color:#555}
canvas{max-width:100%;border-radius:8px;background:#fff;border:1px solid #ddd}
.log{font-family:monospace;background:#0f1724;color:#bcd;padding:8px;border-radius:6px;max-height:160px;overflow:auto;font-size:12px;white-space:pre-wrap}
input[type="file"]{display:none}
label.upload-btn{background:#007bff;color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:14px}
input.msInput{padding:8px;border-radius:6px;border:1px solid #ccc;width:120px}
</style>
</head>
<body>
<div class="wrap">
  <header><h1>Tool Gh√©p Skin + ·∫¢nh Acc + L·ªãch S·ª≠ + M√£ S·ªë</h1></header>

  <div class="panel">
    <div class="card">
      <div class="small">D√°n chu·ªói th√¥ng tin acc:</div>
      <textarea id="accText" placeholder="vd: Lamonskt:37a31997 | NAME : _Only‚Ä¢GyoÀá‚òª | ... | T∆Ø·ªöNG : 105 | SKIN : 253 | SS : 5 [...]"></textarea>
      
      <div class="row" style="margin-top:8px">
        <button id="btnLoad">Load & Gh√©p</button>
        <button id="btnDownload" class="secondary">T·∫£i ·∫£nh</button>
        <select id="scaleSelect" style="margin-left:auto;padding:6px;border-radius:6px;border:1px solid #ddd">
          <option value="1">Canvas scale 1x</option>
          <option value="1.5">Canvas scale 1.5x</option>
          <option value="2">Canvas scale 2x</option>
        </select>
      </div>

      <hr style="margin:10px 0;border:none;border-top:1px solid #eee"/>

      <div class="row">
        <label for="accImg" class="upload-btn">üì∏ Ch·ªçn ·∫£nh ACC</label>
        <input type="file" id="accImg" accept="image/*">
        <label for="lichsuImg" class="upload-btn">üïπÔ∏è Ch·ªçn ·∫£nh L·ªãch S·ª≠</label>
        <input type="file" id="lichsuImg" accept="image/*">
      </div>

      <div class="row" style="margin-top:8px">
        <label>MS:</label>
        <input type="text" id="msInput" class="msInput" placeholder="001">
      </div>

      <hr style="margin:10px 0;border:none;border-top:1px solid #eee"/>

      <div class="small">Log / tr·∫°ng th√°i:</div>
      <div class="log" id="log">(ch∆∞a c√≥ log)</div>
    </div>

    <div class="card" id="previewWrap">
      <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
        <div class="small">Canvas k·∫øt qu·∫£</div>
        <div class="small" id="countInfo">T∆∞·ªõng: 0 ‚Äî SkinCount: 0 ‚Äî Gh√©p: 0</div>
      </div>
      <canvas id="mainCanvas" width="807" height="1280"></canvas>
    </div>
  </div>
</div>

<script>
(async()=>{
const TOADO_URL = "https://raw.githubusercontent.com/HoshinoKotaSouma/ctvhogo/main/ToadoXyz.json";
const FILEID_URL = "https://raw.githubusercontent.com/HoshinoKotaSouma/ctvhogo/main/FileIdtuong.json";

const $=id=>document.getElementById(id);
const logEl=$('log');
function log(...a){logEl.innerText+=a.map(x=>typeof x==='object'?JSON.stringify(x):x).join(' ')+"\\n";logEl.scrollTop=99999;}

function githubBlobToRaw(u){if(!u)return u;if(u.includes("raw.githubusercontent.com"))return u;return u.replace("https://github.com/","https://raw.githubusercontent.com/").replace("/blob/","/");}

async function fetchJSON(u){const r=await fetch(u);if(!r.ok)throw new Error("Fetch l·ªói "+u+" ‚Üí "+r.status);return await r.json();}
function loadImage(url){return new Promise((res,rej)=>{const i=new Image();i.crossOrigin="anonymous";i.onload=()=>res(i);i.onerror=()=>rej("Load fail "+url);i.src=url;});}
function readLocalImage(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=e.target.result;};r.onerror=rej;r.readAsDataURL(file);});}

function parseAcc(t){const r={tuong:0,skinCount:0,cropSkins:[]};if(!t)return r;const tu=t.match(/T∆Ø·ªöNG\\s*:\\s*(\\d+)/i);const sk=t.match(/SKIN\\s*:\\s*(\\d+)/i);r.tuong=tu?parseInt(tu[1]):0;r.skinCount=sk?parseInt(sk[1]):0;const arr=[];let m;const re=/\\[([^\\]]+)\\]/g;while((m=re.exec(t))!==null){m[1].split(',').map(s=>s.trim()).filter(Boolean).forEach(s=>arr.push(s));}r.cropSkins=[...new Set(arr)];return r;}

const canvas=$('mainCanvas');const ctx=canvas.getContext('2d');
let toadoData=null,fileIdMap={};let accImg=null,lichsuImg=null;

$('accImg').addEventListener('change',async e=>{
 if(e.target.files[0]){accImg=await readLocalImage(e.target.files[0]);log("·∫¢nh ACC loaded ‚úì");}
});
$('lichsuImg').addEventListener('change',async e=>{
 if(e.target.files[0]){lichsuImg=await readLocalImage(e.target.files[0]);log("·∫¢nh L·ªãch S·ª≠ loaded ‚úì");}
});

async function initData(){
 try{
  log("üîπ ƒêang t·∫£i ToadoXyz...");
  toadoData=await fetchJSON(TOADO_URL);
  log("‚úÖ Toado loaded.");
  const f=await fetchJSON(FILEID_URL);
  for(const k in f){fileIdMap[k]=f[k];}
  log("‚úÖ FileId loaded:",Object.keys(fileIdMap).length,"entries");
 }catch(e){log("‚ùå L·ªói t·∫£i d·ªØ li·ªáu:",e.message);}
}

function getScale(){const ow=toadoData.image.originalWidth,oh=toadoData.image.originalHeight;return{sx:canvas.width/ow,sy:canvas.height/oh};}
function drawBase(img){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.drawImage(img,0,0,canvas.width,canvas.height);}
function drawTextAt(pos,text,color,size){if(!pos)return;const{sx,sy}=getScale();ctx.fillStyle=color;ctx.font=`bold ${size}px sans-serif`;ctx.strokeStyle="#000";ctx.lineWidth=3;ctx.strokeText(text,pos.x*sx,pos.y*sy);ctx.fillText(text,pos.x*sx,pos.y*sy);}
function drawImageInRegion(img,reg){if(!img||!reg)return;const{sx,sy}=getScale();ctx.drawImage(img,reg.x*sx,reg.y*sy,reg.w*sx,reg.h*sy);}

await initData();

$('btnLoad').addEventListener('click',async()=>{
 try{
  log("üî∏ B·∫Øt ƒë·∫ßu x·ª≠ l√Ω...");
  const accText=$('accText').value.trim();
  const parsed=parseAcc(accText);
  log("Parsed:",parsed);
  const base=await loadImage(toadoData.image.url);
  const sc=parseFloat($('scaleSelect').value)||1;
  canvas.width=toadoData.image.originalWidth*sc;
  canvas.height=toadoData.image.originalHeight*sc;
  drawBase(base);

  // v·∫Ω s·ªë t∆∞·ªõng, skin
  drawTextAt(toadoData.tuong.original,parsed.tuong,"#ff3b3b",36*sc);
  drawTextAt(toadoData.skin.original,parsed.skinCount,"#1f8ef1",36*sc);

  // ch√®n ·∫£nh acc
  if(accImg){drawImageInRegion(accImg,toadoData.extra.acc);log("‚úì ƒê√£ ch√®n ·∫£nh ACC");}
  // ch√®n ·∫£nh l·ªãch s·ª≠
  if(lichsuImg){drawImageInRegion(lichsuImg,toadoData.extra.lichsu);log("‚úì ƒê√£ ch√®n ·∫£nh L·ªãch S·ª≠");}
  // v·∫Ω m√£ s·ªë
  const ms=$('msInput').value.trim();
  if(ms){drawTextAt(toadoData.ms,"MS: "+ms,"#ffd700",toadoData.ms.fontSize||48);log("‚úì ƒê√£ ghi m√£ s·ªë:",ms);}
  log("‚úÖ Ho√†n t·∫•t!");
 }catch(e){log("‚ùå L·ªói:",e.message);}
});

$('btnDownload').addEventListener('click',()=>{
 const link=document.createElement('a');
 link.download='acc_export.png';
 link.href=canvas.toDataURL('image/png');
 link.click();
});

})();
</script>
</body>
</html>
